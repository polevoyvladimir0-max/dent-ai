x-service-defaults: &service-defaults
  restart: unless-stopped
  env_file:
    - .env
  networks:
    - dent-ai-net

services:
  postgres:
    <<: *service-defaults
    image: postgres:16.3-alpine
    container_name: dent_ai_postgres
    labels:
      - autoheal=true
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "${POSTGRES_HOST_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - postgres-backups:/var/lib/postgresql/backups
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]
      interval: 10s
      timeout: 5s
      retries: 5

  qdrant:
    <<: *service-defaults
    image: qdrant/qdrant:v1.15.5
    container_name: dent_ai_qdrant
    labels:
      - autoheal=true
    ports:
      - "${QDRANT_GRPC_PORT:-6333}:6333"
      - "${QDRANT_HTTP_PORT:-6334}:6334"
    volumes:
      - qdrant-storage:/qdrant/storage
      - qdrant-snapshots:/qdrant/snapshots
    healthcheck:
      test: ["CMD", "bash", "-c", "exec 3<>/dev/tcp/127.0.0.1/6333"]
      interval: 15s
      timeout: 5s
      retries: 5

  redis:
    <<: *service-defaults
    image: redis:7.2-alpine
    container_name: dent_ai_redis
    labels:
      - autoheal=true
    command:
      - redis-server
      - "--save"
      - ""
      - "--appendonly"
      - "yes"
      - "--requirepass"
      - "${REDIS_PASSWORD}"
    ports:
      - "${REDIS_HOST_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    <<: *service-defaults
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: dent_ai_minio
    labels:
      - autoheal=true
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: ["minio", "server", "/data", "--console-address", ":9001"]
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:9000/minio/health/ready"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s

  postgres-backup:
    <<: *service-defaults
    image: ${BACKUP_IMAGE:-dent_ai_postgres_backup:dev}
    build:
      context: .
      dockerfile: infra/docker/backup.Dockerfile
    container_name: dent_ai_pg_backup
    labels:
      - autoheal=true
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      BACKUP_BUCKET: ${BACKUP_BUCKET:-dent-ai-backups}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-7}
      BACKUP_SCHEDULE: ${BACKUP_SCHEDULE:-0 3 * * *}
    volumes:
      - postgres-backups:/backups
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_started

  vault:
    <<: *service-defaults
    image: hashicorp/vault:1.17.6
    container_name: dent_ai_vault
    labels:
      - autoheal=true
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_ADDR: ${VAULT_ADDR}
    command: ["vault", "server", "-config=/vault/config/config.hcl"]
    ports:
      - "${VAULT_HOST_PORT:-8200}:8200"
    volumes:
      - ./infra/vault:/vault/config:ro
      - vault-file:/vault/file
      - vault-logs:/vault/logs
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 15s
      timeout: 5s
      retries: 5

  tempo:
    <<: *service-defaults
    image: grafana/tempo:2.6.1
    container_name: dent_ai_tempo
    command: ["-config.file=/etc/tempo/config.yaml"]
    volumes:
      - ./infra/tempo/config.yaml:/etc/tempo/config.yaml:ro
      - tempo-data:/var/tempo
    ports:
      - "3200:3200"
    profiles: ["observability"]

  otel-collector:
    <<: *service-defaults
    image: otel/opentelemetry-collector-contrib:0.101.0
    container_name: dent_ai_otel_collector
    command: ["--config=/etc/otelcol/config.yaml"]
    environment:
      SERVICE_NAME: otel-collector
    volumes:
      - ./infra/otel/config.yaml:/etc/otelcol/config.yaml:ro
    ports:
      - "4317:4317"
      - "4318:4318"
      - "9100:9100"
    depends_on:
      - loki
      - tempo
    healthcheck:
      test: ["CMD", "/otelcol-contrib", "validate", "--config", "/etc/otelcol/config.yaml"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles: ["observability"]

  loki:
    <<: *service-defaults
    image: grafana/loki:3.0.0
    container_name: dent_ai_loki
    command: ["-config.file=/etc/loki/config.yaml"]
    ports:
      - "${LOKI_PORT:-3100}:3100"
    volumes:
      - ./infra/loki/config.yaml:/etc/loki/config.yaml:ro
      - loki-data:/loki
    profiles: ["observability"]

  promtail:
    <<: *service-defaults
    image: grafana/promtail:3.0.0
    container_name: dent_ai_promtail
    command: ["-config.file=/etc/promtail/config.yaml"]
    volumes:
      - ./infra/promtail/config.yaml:/etc/promtail/config.yaml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    depends_on:
      - loki
    profiles: ["observability"]

  blackbox-exporter:
    <<: *service-defaults
    image: prom/blackbox-exporter:v0.25.0
    container_name: dent_ai_blackbox
    command:
      - "--config.file=/etc/blackbox/config.yml"
    volumes:
      - ./infra/blackbox/config.yml:/etc/blackbox/config.yml:ro
    profiles: ["observability"]

  prometheus:
    <<: *service-defaults
    image: prom/prometheus:v3.0.0
    container_name: dent_ai_prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=${PROMETHEUS_RETENTION:-15d}"
      - "--web.enable-lifecycle"
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./infra/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./infra/prometheus/rules:/etc/prometheus/rules:ro
      - prometheus-data:/prometheus
    depends_on:
      - otel-collector
      - blackbox-exporter
    profiles: ["observability"]

  grafana:
    <<: *service-defaults
    image: grafana/grafana:11.1.0
    container_name: dent_ai_grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-change-me}
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
      GF_FEATURE_TOGGLES_ENABLE: "unifiedAlerting"
      GRAFANA_ALERT_TELEGRAM_BOT_TOKEN: ${GRAFANA_ALERT_TELEGRAM_BOT_TOKEN:-}
      GRAFANA_ALERT_TELEGRAM_CHAT_ID: ${GRAFANA_ALERT_TELEGRAM_CHAT_ID:-}
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    volumes:
      - ./infra/grafana/provisioning:/etc/grafana/provisioning
      - grafana-data:/var/lib/grafana
    depends_on:
      - loki
      - otel-collector
      - prometheus
      - tempo
    profiles: ["observability"]

  app:
    <<: *service-defaults
    image: ${APP_IMAGE:-dent_ai_app:dev}
    build:
      context: .
      dockerfile: infra/docker/app.Dockerfile
    container_name: dent_ai_app
    labels:
      - autoheal=true
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      QDRANT_URL: http://qdrant:6333
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      VAULT_ADDR: ${VAULT_ADDR}
      VAULT_TOKEN: ${VAULT_TOKEN}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT}
      DATABASE_URL: postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
    ports:
      - "${APP_HOST_PORT:-8000}:8000"
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_started
      vault:
        condition: service_started

  bot:
    <<: *service-defaults
    image: ${BOT_IMAGE:-dent_ai_bot:dev}
    build:
      context: .
      dockerfile: infra/docker/bot.Dockerfile
    container_name: dent_ai_bot
    labels:
      - autoheal=true
    environment:
      TELEGRAM_BOT_TOKEN: ${BOT_TOKEN}
      PRICING_API_BASE: http://app:8000
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT}
      DATABASE_URL: postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
    depends_on:
      app:
        condition: service_started
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      postgres:
        condition: service_healthy

  autoheal:
    <<: *service-defaults
    image: willfarrell/autoheal:1.2.0
    container_name: dent_ai_autoheal
    environment:
      AUTOHEAL_CONTAINER_LABEL: autoheal=true
      AUTOHEAL_INTERVAL: ${AUTOHEAL_INTERVAL:-5}
      AUTOHEAL_START_PERIOD: ${AUTOHEAL_START_PERIOD:-30}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

networks:
  dent-ai-net:
    driver: bridge

volumes:
  postgres-data:
  postgres-backups:
  qdrant-storage:
  qdrant-snapshots:
  redis-data:
  minio-data:
  vault-file:
  vault-logs:
  loki-data:
  grafana-data:
  tempo-data:
  prometheus-data:

